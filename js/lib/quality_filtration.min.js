!function(e){"use strict";var t,n,o,r,i;56.9441,.8,163.4145573051634,o=function(e,t,n){var o=0,r={x:[],y:[],valid:[],equation:{string:n}},i={x:[],y:[],valid:[],equation:{string:n}};for(o=0;o<e.length;o+=1)i.x.push(e[o][t]),i.y.push(e[o].signal),i.valid.push(e[o].signal_valid),r.x.push(e[o][t]),r.y.push(e[o].background),r.valid.push(e[o].background_valid);return{signal:i,background:r}},n=function(e,t){return function(n){if(!n.get||"function"!=typeof n.get)throw"Data object does not have get function attached. Use get_kinome.js to add this on.";var r,i,a,u,s,l=[];(n=n.clone()).level="1.0.1",s=function(r){var i,a,u,l=!1;if(r[1].robust&&r[1].remove>=0&&n.get(r[0])[r[1].remove].set(r[0].type+"_valid",0),!r[1].robust||r[1].remove>=0){for(i=0;!l&&i<r[1].errors.length;i+=1)Math.pow(r[1].errors[i].error,2)>56.9441&&(l=!0);if(l&&r[1].errors.length>3)return a=n.get(r[0]),u=o(a,"exposure","linear"),u[r[0].type].equation.robust=!0,e.submit({model:u[r[0].type],origin:r[0]}).then(s)}return t.done+=1,r[0].exposure=null,r[0].value=r[1].parameters[0],r[0].valid=r[1].R2>.8?1:0,Number.isFinite(r[0].cycle)&&n.put(r[0]),!0},r=n.list("cycle"),i=n.list("peptides");var d,c;for(d=0;d<i.length;d+=1)for(c=0;c<r.length;c+=1)(a=n.get({peptide:i[d],cycle:r[c]})).length>1&&(u=o(a,"exposure","linear"),t.total+=2,l.push(e.submit({model:u.signal,origin:{peptide:i[d],cycle:r[c],type:"signal"}}).then(s)),l.push(e.submit({model:u.background,origin:{peptide:i[d],cycle:r[c],type:"background"}}).then(s)));return Promise.all(l).then(function(){return n}).catch(function(e){console.log("something failed...",e)})}},r=function(e,t,n){return function(r){if(!r.get||"function"!=typeof r.get)throw"Data object does not have get function attached. Use get_kinome.js to add this on.";var i,a,u,s,l,d,c=[],p=[],g=0;r=r.clone(),d=function(e){var t,n;for(t=0;void 0===n&&t<e.y.length;t+=1)e.valid[t]&&(n=e.y[t]);for(n-=5,t=0;t<e.y.length;t+=1)e.y[t]-=n;return e},l=function(i){var a,u,s,p=!1;if(i[1].robust||i[1].errors.map(function(e){c.push(e.error+"\t"+e.y)}),i[1].robust&&i[1].remove>=0&&r.get(i[0])[i[1].remove].set(i[0].type+"_valid",0),!i[1].robust||i[1].remove>=0&&i[1].robust<4){for(a=0;!p&&a<i[1].errors.length;a+=1)Math.pow(i[1].errors[a].error,2)>163.4145573051634&&(p=!0);if(p&&i[1].errors.length>8)return i[1].robust||(g+=1),u=r.get(i[0]),s=o(u,"cycle",t),s[i[0].type].equation.robust=i[1].robust||0,s[i[0].type].equation.robust+=1,e.submit({model:d(s[i[0].type]),origin:i[0]}).then(l)}return n.done+=1,!0},i=r.list("exposure"),a=r.list("peptides");var f,h;for(f=0;f<a.length;f+=1)for(h=0;h<i.length;h+=1)(u=r.get({peptide:a[f],exposure:i[h]})).length>1&&(s=o(u,"cycle",t),n.total+=2,p.push(e.submit({model:d(s.signal),origin:{peptide:a[f],exposure:i[h],type:"signal"}}).then(l)),p.push(e.submit({model:d(s.background),origin:{peptide:a[f],exposure:i[h],type:"background"}}).then(l)));return Promise.all(p).then(function(){return r}).catch(function(e){console.error("kinetic something failed...",JSON.stringify(e))})}},i=function(e){var t,n,o,r,i,a,u,s=e.list("exposures");for(o=function(e){var t=1/0;return e.background_valid&&(t=Math.min(t,e.background)),e.signal_valid&&Math.min(t,e.signal),t},r=function(e,t){return"number"==typeof e&&"number"==typeof t?Math.min(e,t):"number"==typeof e?e:"number"==typeof t?t:1/0},a=e.list("cycles").reduce(r),t=0;t<s.length;t+=1)if((u=e.get({cycle:a,exposure:s[t]})).length>1)for(i=u.map(o).reduce(r),u=e.get({exposure:s[t]}),n=0;n<u.length;n+=1)u[n].set("signal",u[n].signal-i),u[n].set("background",u[n].background-i);return e},t=function(e){return new Promise(function(t,o){e.data&&"object"==typeof e.data||o("Data object not added in. This will not work without it."),e.amd_ww&&"object"==typeof e.amd_ww||o("AMD_WW object not added in. This will not work without it."),e.equation&&"string"==typeof e.equation||o("Equation string not added in. This will not work without it."),e.worker&&"string"==typeof e.worker||o("String for worker url not added in. This will not work without it."),Array.isArray(e.data)||(e.data=[e.data]);var a,u,s,l={done:0,total:0},d={done:0,total:0};s=e.number_threads||void 0,u=e.amd_ww.start({filename:e.worker,num_workers:s}),console.log("\nStarting fits for outlier detection.\n"),a=Promise.all(e.data.map(n(u,l))).catch(function(e){o("Linear fit failed"+e)}),e.hasOwnProperty("linearUpdate")&&"function"==typeof e.linearUpdate&&e.linearUpdate(l),a.then(function(t){var n=Promise.all(t.map(r(u,e.equation,d)));return e.hasOwnProperty("kineticUpdate")&&"function"==typeof e.kineticUpdate&&e.kineticUpdate(d),n}).then(function(e){e=e.map(i),t(e)}).catch(function(e){o(e)})})},e.filter=t}("undefined"!=typeof module&&module.exports?module.exports:KINOME);